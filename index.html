<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#d9534f">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23d9534f' width='100' height='100'/><text y='75' font-size='75' fill='white' text-anchor='middle' x='50'>üçΩÔ∏è</text></svg>">
    <title>Order Menu</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        :root {
            --primary-color: #d9534f;
            --secondary-color: #f7f7f7;
            --text-color: #333;
            --border-color: #ddd;
            --veg-color: #008000;
            --non-veg-color: #b30000;
            --egg-color: #e69500;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #000;
            color: var(--text-color);
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            position: fixed;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .phone-wrapper {
            width: 100%;
            height: 100%;
            max-width: 100vw;
            max-height: 100vh;
            border: none;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            position: relative;
            background: #fff;
        }

        .app-container {
            display: flex;
            height: 100%;
            flex-direction: column;
        }
        
        .header {
            padding: max(env(safe-area-inset-top), 15px) 20px 15px 20px;
            background: #fff;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .header h1 {
            font-size: clamp(1.2em, 4vw, 1.5em);
            color: var(--primary-color);
        }
        #table-number-display {
            font-size: clamp(0.75em, 3vw, 0.8em);
            color: #555;
            font-weight: 500;
        }

        .loading-message {
            padding: 40px 20px;
            text-align: center;
            color: #666;
            font-size: clamp(0.95em, 3.5vw, 1em);
        }

        .menu-container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }

        .category-list {
            width: clamp(100px, 25vw, 120px);
            background-color: var(--secondary-color);
            overflow-y: auto;
            overflow-x: hidden;
            border-right: 1px solid var(--border-color);
            padding-top: 10px;
            flex-shrink: 0;
            -webkit-overflow-scrolling: touch;
        }

        .category-list ul {
            list-style-type: none;
        }

        .category-list li {
            padding: 15px 10px;
            cursor: pointer;
            font-weight: 500;
            font-size: clamp(0.8em, 3vw, 0.9em);
            color: #555;
            border-left: 4px solid transparent;
            transition: all 0.2s ease-in-out;
            -webkit-tap-highlight-color: transparent;
            word-wrap: break-word;
        }

        .category-list li:hover {
            background-color: #e9e9e9;
        }

        .category-list li.active {
            background-color: #fff;
            color: var(--primary-color);
            font-weight: 700;
            border-left-color: var(--primary-color);
        }

        .item-list {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            padding-bottom: max(env(safe-area-inset-bottom), 100px);
            -webkit-overflow-scrolling: touch;
        }

        .item-card {
            display: flex;
            align-items: center;
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: box-shadow 0.2s ease;
        }

        .item-card:active {
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }
        
        .item-details {
            flex-grow: 1;
        }

        .item-name {
            display: flex;
            align-items: center;
            font-weight: 700;
            font-size: clamp(0.95em, 3.5vw, 1em);
            margin-bottom: 5px;
            line-height: 1.3;
        }
        
        .attribute-icon {
            width: 14px;
            height: 14px;
            border-radius: 2px;
            border: 1.5px solid;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .attribute-icon::after {
            content: '';
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background-color: currentColor;
        }

        .attribute-icon.veg { border-color: var(--veg-color); color: var(--veg-color); }
        .attribute-icon.non-veg { border-color: var(--non-veg-color); color: var(--non-veg-color); }
        .attribute-icon.egg { border-color: var(--egg-color); color: var(--egg-color); }

        .item-price {
            font-size: clamp(0.85em, 3vw, 0.9em);
            color: #666;
            font-weight: 500;
        }

        .item-action-container {
            min-width: 90px;
            text-align: center;
            margin-left: 10px;
        }

        .add-button, .item-quantity-control {
            background-color: #fff;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 25px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        .add-button { 
            padding: 10px 22px;
            font-size: clamp(0.85em, 3vw, 0.9em);
            min-height: 44px;
        }
        .add-button:active { 
            background-color: var(--primary-color); 
            color: #fff;
            transform: scale(0.95);
        }

        .item-quantity-control {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            min-height: 44px;
        }
        .item-quantity-control button {
            background: transparent;
            border: none;
            color: var(--primary-color);
            font-size: 1.3em;
            font-weight: 700;
            cursor: pointer;
            min-width: 35px;
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .item-quantity-control button:active {
            transform: scale(0.9);
        }
        .item-quantity-control span {
            min-width: 30px;
            text-align: center;
            font-size: 1em;
        }

        .cart-summary {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px max(env(safe-area-inset-bottom), 15px) 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            cursor: pointer;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            z-index: 50;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
            -webkit-tap-highlight-color: transparent;
        }
        
        .cart-summary.visible {
            transform: translateY(0);
        }
        
        #view-order-btn {
            background: #fff;
            color: var(--primary-color);
            border: none;
            padding: 10px 18px;
            border-radius: 25px;
            font-weight: 700;
            cursor: pointer;
            animation: pulse 2s infinite;
            font-size: clamp(0.9em, 3vw, 1em);
            min-height: 44px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        #view-order-btn:active {
            transform: scale(0.95);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: flex-end;
            z-index: 200;
            backdrop-filter: blur(2px);
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 100vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 20px 20px 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .close-btn { 
            font-size: 1.8rem; 
            cursor: pointer; 
            color: #888;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }
        .close-btn:active {
            transform: scale(0.9);
        }
        
        .modal-item-name { 
            font-size: clamp(1.1em, 4vw, 1.2em); 
            font-weight: 700;
            line-height: 1.3;
        }
        .modal-item-price { 
            font-size: clamp(0.95em, 3vw, 1em); 
            color: #555; 
        }

        .modal-body { 
            padding: 20px; 
            overflow-y: auto; 
            flex-grow: 1;
            -webkit-overflow-scrolling: touch;
        }
        .addon-group { margin-bottom: 25px; }
        .addon-group h4 { 
            font-size: clamp(0.95em, 3.5vw, 1em); 
            font-weight: 600; 
            margin-bottom: 12px; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 8px;
            color: #333;
        }
        .addon-item { 
            display: flex; 
            align-items: center; 
            margin-bottom: 14px;
            padding: 10px;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .addon-item:active {
            background: #f5f5f5;
        }
        .addon-item input { 
            margin-right: 12px;
            min-width: 20px;
            min-height: 20px;
            cursor: pointer;
        }
        .addon-item label { 
            flex-grow: 1;
            font-size: clamp(0.9em, 3vw, 0.95em);
            cursor: pointer;
            line-height: 1.4;
        }
        .addon-item .price { 
            font-weight: 600;
            color: var(--primary-color);
            font-size: clamp(0.9em, 3vw, 0.95em);
        }
        .instructions { 
            width: 100%; 
            padding: 12px; 
            border-radius: 8px; 
            border: 1.5px solid var(--border-color); 
            margin-top: 10px; 
            resize: vertical; 
            min-height: 80px;
            font-size: clamp(0.9em, 3vw, 0.95em);
            font-family: 'Roboto', sans-serif;
        }

        .modal-footer { 
            padding: 15px 20px max(env(safe-area-inset-bottom), 15px) 20px; 
            border-top: 1px solid var(--border-color); 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            background: #fff;
            position: sticky;
            bottom: 0;
        }
        .quantity-control { 
            display: flex; 
            align-items: center;
            background: var(--secondary-color);
            border-radius: 25px;
            padding: 4px;
        }
        .quantity-btn { 
            background: white;
            border: none;
            min-width: 40px;
            min-height: 40px;
            font-size: 1.3em;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            font-weight: 700;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .quantity-btn:active {
            transform: scale(0.9);
            background: #f0f0f0;
        }
        .quantity-display { 
            padding: 0 20px; 
            font-weight: 700; 
            font-size: clamp(1em, 4vw, 1.1em);
            min-width: 50px;
            text-align: center;
        }
        .add-to-cart-btn { 
            background: var(--primary-color); 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 25px; 
            font-weight: 700; 
            cursor: pointer;
            font-size: clamp(0.9em, 3vw, 1em);
            min-height: 48px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .add-to-cart-btn:active {
            transform: scale(0.95);
            background: #c74943;
        }
        
        #cart-modal-body { 
            padding: 0;
            -webkit-overflow-scrolling: touch;
        }
        .cart-item { 
            padding: 18px 20px; 
            border-bottom: 1px solid #eee; 
        }
        .cart-item:last-child { border-bottom: none; }
        .cart-item-name { 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            margin-bottom: 8px;
            font-size: clamp(0.95em, 3.5vw, 1em);
            line-height: 1.3;
        }
        .cart-item-addons { 
            font-size: clamp(0.8em, 2.8vw, 0.85em); 
            color: #666; 
            margin-left: 22px;
            line-height: 1.5;
        }
        .cart-item-instructions { 
            font-size: clamp(0.8em, 2.8vw, 0.85em); 
            color: #d9534f; 
            margin-left: 22px; 
            font-style: italic;
            line-height: 1.4;
            margin-top: 5px;
        }
        .cart-item-footer { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-top: 12px; 
        }
        .cart-item-actions button { 
            font-size: clamp(0.8em, 2.8vw, 0.85em); 
            padding: 8px 14px; 
            border: 1.5px solid; 
            border-radius: 20px; 
            cursor: pointer; 
            background: white; 
            margin-left: 8px;
            font-weight: 600;
            min-height: 36px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .cart-item-actions button:active {
            transform: scale(0.95);
        }
        .cart-edit-btn { 
            color: #5bc0de; 
            border-color: #5bc0de; 
        }
        .cart-edit-btn:active {
            background: #e6f7fb;
        }
        .cart-remove-btn { 
            color: #d9534f; 
            border-color: #d9534f; 
        }
        .cart-remove-btn:active {
            background: #fef2f2;
        }
        .cart-item-price { 
            font-weight: 700;
            font-size: clamp(0.95em, 3.5vw, 1em);
            color: var(--primary-color);
        }
        #cart-modal-footer { 
            justify-content: center; 
        }
        .totals-summary { 
            padding: 18px 20px; 
            border-top: 2px solid #eee;
            background: #fafafa;
        }
        .totals-row { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 8px; 
            font-size: clamp(0.9em, 3vw, 0.95em);
        }
        .totals-row.grand-total { 
            font-weight: 700; 
            font-size: clamp(1.05em, 4vw, 1.15em); 
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #ddd;
            color: var(--primary-color);
        }

        #send-whatsapp-btn {
            background: #25D366;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 30px;
            font-weight: 700;
            cursor: pointer;
            font-size: clamp(0.95em, 3.5vw, 1.05em);
            min-height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
            transition: all 0.2s ease;
        }

        #send-whatsapp-btn:active {
            transform: scale(0.97);
            background: #20ba5a;
        }
        
        #send-whatsapp-btn.disabled-btn {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        #send-whatsapp-btn.disabled-btn:active {
            transform: none;
            background: #ccc;
        }

        * {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        input:focus, textarea:focus, button:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        button {
            -webkit-user-select: none;
            user-select: none;
        }

        #cancel-order-btn:active {
            transform: scale(0.95);
            background: #f5f5f5;
        }

        #confirm-send-btn:active {
            transform: scale(0.95);
            background: #20ba5a;
        }
    </style>
</head>
<body>

    <div class="phone-wrapper">
        <div class="app-container">
            <header class="header">
                <h1>Our Menu <span id="table-number-display"></span></h1>
            </header>
            <div class="menu-container">
                <aside class="category-list"><ul id="category-list-ul"></ul></aside>
                <main class="item-list" id="item-list-main">
                    <div class="loading-message">Loading menu...</div>
                </main>
            </div>
            <div class="cart-summary" id="cart-summary-bar">
                <div><span id="cart-item-count">0 Items</span> | ‚Çπ<span id="cart-total-price">0</span></div>
                <button id="view-order-btn">View Order</button>
            </div>
        </div>

        <div class="modal-overlay" id="customization-modal-overlay">
            <div class="modal" id="customization-modal-content"></div>
        </div>
        
        <div class="modal-overlay" id="cart-modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <h3>Your Order</h3>
                    <span class="close-btn" id="close-cart-modal">&times;</span>
                </div>
                <div class="modal-body" id="cart-modal-body"></div>
                <div class="totals-summary" id="cart-totals-summary"></div>
                <div style="padding: 0 20px 15px 20px;">
                    <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                        <input type="text" id="discount-code-input" placeholder="Discount Code" style="flex: 1; padding: 12px; border: 1.5px solid #ddd; border-radius: 8px; font-size: 1em;">
                        <button id="apply-discount-btn" style="background: var(--primary-color); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; min-width: 80px;">Apply</button>
                    </div>
                    <div id="discount-message" style="font-size: 0.9em; margin-bottom: 10px; text-align: center;"></div>
                    <textarea id="general-instructions" class="instructions" placeholder="Any general instructions? (e.g., less spicy)"></textarea>
                </div>
                <div class="modal-footer" id="cart-modal-footer">
                    <button id="send-whatsapp-btn">
                        <span>üì±</span> Send Order on WhatsApp
                    </button>
                    <div id="final-check-status" style="display: none; text-align: center; font-size: 0.9em; margin-top: 10px; color: #666;">Verifying outlet status...</div>
                </div>
            </div>
        </div>

        <div class="modal-overlay" id="confirmation-modal-overlay" style="z-index: 300;">
            <div class="modal">
                <div class="modal-header" style="background: #25D366; color: white;">
                    <h3>Confirm Your Order</h3>
                    <span class="close-btn" id="close-confirmation-modal" style="color: white;">&times;</span>
                </div>
                <div class="modal-body" style="padding: 25px 20px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 3em; margin-bottom: 10px;">üìã</div>
                        <h4 style="font-size: 1.3em; color: #333; margin-bottom: 20px;">Order Summary</h4>
                    </div>
                    <div id="confirmation-details" style="background: #f9f9f9; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    </div>
                    <div style="text-align: center; color: #666; font-size: 0.9em; margin-bottom: 20px;">
                        Review your order before sending to WhatsApp
                    </div>
                </div>
                <div class="modal-footer" style="padding: 15px 20px; display: flex; gap: 10px; justify-content: center;">
                    <button id="cancel-order-btn" style="background: white; color: #666; border: 2px solid #ddd; padding: 12px 24px; border-radius: 25px; font-weight: 700; cursor: pointer; font-size: 1em; min-height: 48px; flex: 1; max-width: 150px;">Cancel</button>
                    <button id="confirm-send-btn" style="background: #25D366; color: white; border: none; padding: 12px 24px; border-radius: 25px; font-weight: 700; cursor: pointer; font-size: 1em; min-height: 48px; flex: 1; max-width: 150px; box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);">Send Order</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        const GST_RATE = 0.05;

        const MENU_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTlM6BGIWdct_szKaONKItArAjOzdEgw-780Qha42rhQNY4_xZ15x8VxzRzzEhlUz8CDGsSY4wbjrip/pub?gid=0&single=true&output=csv';
        const ADDONS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTlM6BGIWdct_szKaONKItArAjOzdEgw-780Qha42rhQNY4_xZ15x8VxzRzzEhlUz8CDGsSY4wbjrip/pub?gid=68309898&single=true&output=csv';
        const CONFIG_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTlM6BGIWdct_szKaONKItArAjOzdEgw-780Qha42rhQNY4_xZ15x8VxzRzzEhlUz8CDGsSY4wbjrip/pub?gid=864388739&single=true&output=csv';
        const DISCOUNT_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTlM6BGIWdct_szKaONKItArAjOzdEgw-780Qha42rhQNY4_xZ15x8VxzRzzEhlUz8CDGsSY4wbjrip/pub?gid=278622700&single=true&output=csv';

        let menuItems = [];
        let addons = [];
        let config = {};
        let cart = [];
        let currentItemForModal = null;
        let editingCartItemIndex = null;
        let activeCategory = null;
        let tableNumber = null;
        let appliedDiscount = null;
        let userLocation = null;
        let outletOpen = true;
        
        const categoryListUl = document.getElementById('category-list-ul');
        const itemListMain = document.getElementById('item-list-main');
        const cartSummaryBar = document.getElementById('cart-summary-bar');
        const cartItemCountSpan = document.getElementById('cart-item-count');
        const cartTotalPriceSpan = document.getElementById('cart-total-price');
        
        const custModalOverlay = document.getElementById('customization-modal-overlay');
        const custModalContent = document.getElementById('customization-modal-content');
        
        const cartModalOverlay = document.getElementById('cart-modal-overlay');
        const cartModalBody = document.getElementById('cart-modal-body');
        const cartTotalsSummary = document.getElementById('cart-totals-summary');
        const closeCartModalBtn = document.getElementById('close-cart-modal');
        const sendWhatsappBtn = document.getElementById('send-whatsapp-btn');
        const viewOrderBtn = document.getElementById('view-order-btn');

        const confirmationModalOverlay = document.getElementById('confirmation-modal-overlay');
        const closeConfirmationModalBtn = document.getElementById('close-confirmation-modal');
        const cancelOrderBtn = document.getElementById('cancel-order-btn');
        const confirmSendBtn = document.getElementById('confirm-send-btn');

        async function fetchDiscountCodes() {
            try {
                const response = await fetch(DISCOUNT_CSV_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const csvText = await response.text();
                console.log('Discount codes CSV loaded');
                
                const lines = csvText.trim().split('\n');
                const headers = lines.shift().split(',').map(h => h.trim());
                
                console.log('Discount CSV headers:', headers);
                
                const discountCodes = {};
                
                lines.forEach((line, index) => {
                    const values = line.split(',').map(v => v.trim());
                    if (values.length >= 3) {
                        const code = values[0];
                        const discount = values[1];
                        const category = values[2];
                        
                        if (code) {
                            // Support multiple discounts per code
                            if (!discountCodes[code]) {
                                discountCodes[code] = [];
                            }
                            discountCodes[code].push({
                                discount: discount,
                                category: category
                            });
                            console.log(`Loaded discount code: ${code} = ${discount} for ${category}`);
                        }
                    }
                });
                
                console.log('Total discount codes loaded:', Object.keys(discountCodes).length);
                console.log('Discount codes object:', discountCodes);
                
                return discountCodes;
            } catch (error) {
                console.error("Error fetching discount codes:", error);
                return {};
            }
        }

        async function fetchAndParseCSV(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                
                const lines = csvText.trim().split('\n');
                const headers = lines.shift().split(',').map(h => h.trim());
                
                return lines.map(line => {
                    const values = line.split(',');
                    const item = {};
                    
                    headers.forEach((header, i) => {
                        let value = values[i] ? values[i].trim() : '';
                        
                        if (header === 'Price' || header === 'Addon_Item_Price') {
                            item[header] = parseInt(value, 10) || 0; 
                        } else {
                            item[header] = value;
                        }
                    });
                    return item;
                });

            } catch (error) {
                console.error("Error fetching or parsing CSV:", error);
                return [];
            }
        }

        async function fetchConfig() {
            try {
                const response = await fetch(CONFIG_CSV_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const csvText = await response.text();
                console.log('Config CSV loaded');
                
                const lines = csvText.trim().split('\n');
                const header = lines.shift();
                
                const configObj = {};
                
                lines.forEach(line => {
                    const firstCommaIndex = line.indexOf(',');
                    if (firstCommaIndex === -1) return;
                    
                    const key = line.substring(0, firstCommaIndex).trim();
                    const value = line.substring(firstCommaIndex + 1).trim();
                    
                    if (key && value) {
                        configObj[key] = value;
                        console.log(`Config: ${key} = ${value}`);
                    }
                });
                
                console.log('Fetching discount codes...');
                configObj.discountCodes = await fetchDiscountCodes();
                
                if (configObj['Lat,Long']) {
                    const [lat, lng] = configObj['Lat,Long'].split(',').map(s => parseFloat(s.trim()));
                    configObj.outletLocation = { lat, lng };
                }
                
                if (configObj['gps coordinate']) {
                    configObj.deliveryRadius = parseFloat(configObj['gps coordinate'].replace(/[^\d.]/g, ''));
                }
                
                console.log('Full config loaded:', configObj);
                return configObj;
            } catch (error) {
                console.error("Error fetching config:", error);
                return {};
            }
        }

        function checkOutletStatus() {
            if (!config['on time'] || !config['off time']) {
                console.log('No time configuration found, outlet open by default');
                return { open: true };
            }
            
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            const currentDay = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][now.getDay()];
            const currentDate = `${String(now.getDate()).padStart(2, '0')}-${String(now.getMonth() + 1).padStart(2, '0')}-${now.getFullYear()}`;
            const currentDateSlash = `${String(now.getDate()).padStart(2, '0')}/${String(now.getMonth() + 1).padStart(2, '0')}/${now.getFullYear()}`;
            
            console.log('Current time (minutes):', currentTime);
            console.log('Current day:', currentDay);
            console.log('Current date:', currentDate, 'or', currentDateSlash);
            
            const onTimeParts = config['on time'].split(':');
            const onHour = parseInt(onTimeParts[0]);
            const onMin = onTimeParts[1] ? parseInt(onTimeParts[1]) : 0;
            const onTime = onHour * 60 + onMin;
            
            const offTimeParts = config['off time'].split(':');
            const offHour = parseInt(offTimeParts[0]);
            const offMin = offTimeParts[1] ? parseInt(offTimeParts[1]) : 0;
            const offTime = offHour * 60 + offMin;
            
            if (currentTime < onTime || currentTime > offTime) {
                return { 
                    open: false, 
                    reason: `We're open from ${config['on time']} to ${config['off time']}. Current time: ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}` 
                };
            }
            
            if (config['off days']) {
                const offDays = config['off days'].toLowerCase().split(',').map(d => d.trim());
                if (offDays.includes(currentDay)) {
                    return { open: false, reason: `We're closed on ${currentDay.charAt(0).toUpperCase() + currentDay.slice(1)}days` };
                }
            }
            
            if (config['holidays']) {
                const holidays = config['holidays'].split(',').map(d => d.trim());
                if (holidays.includes(currentDate) || holidays.includes(currentDateSlash)) {
                    return { open: false, reason: "We're closed for the holiday today" };
                }
            }
            
            return { open: true };
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        async function checkUserLocation() {
            if (!config['gps check'] || config['gps check'].toLowerCase() === 'no') {
                console.log("GPS check disabled in config, skipping location verification");
                return { allowed: true };
            }
            
            console.log("GPS check enabled, verifying location...");
            
            if (!config.outletLocation || !config.deliveryRadius) {
                console.log("No location config, skipping location check");
                return { allowed: true };
            }
            
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    console.log("Geolocation not supported");
                    resolve({ allowed: true });
                    return;
                }
                
                console.log("Requesting user location...");
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        console.log("User location:", userLocation);
                        console.log("Outlet location:", config.outletLocation);
                        
                        const distance = calculateDistance(
                            userLocation.lat,
                            userLocation.lng,
                            config.outletLocation.lat,
                            config.outletLocation.lng
                        );
                        
                        console.log("Distance:", distance.toFixed(2), "km");
                        console.log("Delivery radius:", config.deliveryRadius, "km");
                        
                        if (distance > config.deliveryRadius) {
                            resolve({ 
                                allowed: false, 
                                reason: `You are ${distance.toFixed(1)}km away. We deliver within ${config.deliveryRadius}km.` 
                            });
                        } else {
                            resolve({ allowed: true });
                        }
                    },
                    (error) => {
                        console.log('Location access denied or unavailable:', error);
                        resolve({ allowed: true });
                    }
                );
            });
        }

        function showClosedOverlay(reason) {
            const overlay = document.createElement('div');
            overlay.id = 'closed-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: transparent;
                z-index: 9999;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                color: white;
                text-align: center;
                padding: 20px;
                pointer-events: none;
            `;
            overlay.innerHTML = `
                <div style="background: rgba(0, 0, 0, 0.75); padding: 30px 20px; border-radius: 20px; pointer-events: auto; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); max-width: 85%; border: 2px solid rgba(217, 83, 79, 0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);">
                    <div style="font-size: 3em; margin-bottom: 12px;">üîí</div>
                    <h2 style="font-size: 1.5em; margin-bottom: 10px; font-weight: 700; color: #ff6b6b;">Outlet Closed</h2>
                    <p style="font-size: 1em; max-width: 350px; line-height: 1.3; margin-bottom: 12px;">${reason}</p>
                    <p style="font-size: 0.85em; opacity: 0.9; color: #ffd93d; font-weight: 500;">Browse menu ‚Ä¢ Cannot place orders</p>
                </div>
            `;
            document.body.appendChild(overlay);
            outletOpen = false;
        }

        async function loadMenuData() {
            console.log("Loading configuration...");
            config = await fetchConfig();
            console.log("Config loaded:", config);
            
            const statusCheck = checkOutletStatus();
            console.log("Status check result:", statusCheck);
            
            const locationCheck = await checkUserLocation();
            console.log("Location check result:", locationCheck);
            
            // Load menu data regardless of status
            console.log("Loading menu items...");
            menuItems = await fetchAndParseCSV(MENU_CSV_URL);
            
            console.log("Loading add-ons...");
            addons = await fetchAndParseCSV(ADDONS_CSV_URL);

            console.log("Data loaded successfully!");
            
            // Show overlay if closed but allow browsing
            if (!statusCheck.open) {
                showClosedOverlay(statusCheck.reason);
                return;
            }
            
            if (!locationCheck.allowed) {
                showClosedOverlay(locationCheck.reason);
                return;
            }
        }

        function getTableNumberFromURL() {
            const params = new URLSearchParams(window.location.search);
            const table = params.get('table');
            if (table && table.trim() !== '') {
                tableNumber = table.trim();
                document.getElementById('table-number-display').textContent = `- Table ${tableNumber}`;
            }
        }

        function getAttributeClass(attribute) {
            if (!attribute) return '';
            const attr = attribute.toLowerCase().trim();
            if (attr === 'veg') return 'veg';
            if (attr === 'non-veg') return 'non-veg';
            if (attr === 'egg') return 'egg';
            return '';
        }

        function renderCategories() {
            const categories = [...new Set(menuItems.map(item => item.Category))];
            categoryListUl.innerHTML = '';
            categories.forEach(category => {
                const li = document.createElement('li');
                li.textContent = category;
                li.dataset.category = category;
                li.addEventListener('click', () => {
                    document.querySelector('.category-list li.active')?.classList.remove('active');
                    li.classList.add('active');
                    activeCategory = category;
                    renderItems(category);
                });
                categoryListUl.appendChild(li);
            });
            if (categoryListUl.firstChild) {
                categoryListUl.firstChild.click();
            }
        }

        function renderItems(category) {
            itemListMain.innerHTML = '';
            const itemsInCategory = menuItems.filter(item => item.Category === category);
            
            itemsInCategory.forEach(item => {
                const itemInCart = cart.find(cartItem => cartItem.Name === item.Name && !cartItem.selectedAddons.length && !cartItem.instructions);
                const itemCard = document.createElement('div');
                itemCard.className = 'item-card';

                let actionHtml;
                if (itemInCart) {
                    actionHtml = `<div class="item-quantity-control"><button class="decrease-item-qty" data-item-name="${item.Name}">-</button><span>${itemInCart.quantity}</span><button class="increase-item-qty" data-item-name="${item.Name}">+</button></div>`;
                } else {
                    actionHtml = `<button class="add-button" data-item-name="${item.Name}">ADD</button>`;
                }

                itemCard.innerHTML = `<div class="item-details"><div class="item-name"><div class="attribute-icon ${getAttributeClass(item.Attributes)}"></div>${item.Name}</div><div class="item-price">‚Çπ${item.Price}</div></div><div class="item-action-container">${actionHtml}</div>`;
                itemListMain.appendChild(itemCard);
            });
            
            itemListMain.querySelectorAll('.add-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const itemName = e.target.dataset.itemName;
                    const item = menuItems.find(i => i.Name === itemName);
                    if (item.Addon_Group_Name) {
                        openCustomizationModal(item);
                    } else {
                        cart.push({ ...item, quantity: 1, selectedAddons: [], instructions: '', subtotal: item.Price });
                        updateCartSummary();
                        renderItems(activeCategory);
                    }
                });
            });

            itemListMain.querySelectorAll('.decrease-item-qty, .increase-item-qty').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const isIncrease = e.target.classList.contains('increase-item-qty');
                    const itemName = e.target.dataset.itemName;
                    const cartIndex = cart.findIndex(i => i.Name === itemName && !i.selectedAddons.length && !i.instructions);
                    if (cartIndex > -1) {
                        if (isIncrease) {
                            cart[cartIndex].quantity++;
                        } else {
                            cart[cartIndex].quantity--;
                        }

                        if (cart[cartIndex].quantity <= 0) {
                             cart.splice(cartIndex, 1);
                        } else {
                            cart[cartIndex].subtotal = cart[cartIndex].Price * cart[cartIndex].quantity;
                        }
                        updateCartSummary();
                        renderItems(activeCategory);
                    }
                });
            });
        }
        
        function openCustomizationModal(item, cartIndex = null) {
            currentItemForModal = item;
            editingCartItemIndex = cartIndex;
            const existingItem = (cartIndex !== null) ? cart[cartIndex] : null;
            const relevantAddons = addons.filter(addon => addon.Addon_Group_Name === item.Addon_Group_Name);
            const addonGroups = {};
            relevantAddons.forEach(addon => {
                if (!addonGroups[addon.Addon_Group_Name]) {
                    addonGroups[addon.Addon_Group_Name] = { items: [], type: addon.Addon_Item_Selection === 'S' ? 'radio' : 'checkbox', name: addon.Addon_Group_Name.replace(/\s+/g, '-') };
                }
                addonGroups[addon.Addon_Group_Name].items.push(addon);
            });
            let addonHtml = '';
            for (const groupName in addonGroups) {
                const group = addonGroups[groupName];
                addonHtml += `<div class="addon-group"><h4>${groupName}</h4>`;
                group.items.forEach(addon => {
                    const isChecked = existingItem ? existingItem.selectedAddons.some(sa => sa.name === addon.Addon_Item_Name) : false;
                    addonHtml += `<div class="addon-item"><input type="${group.type}" name="${group.name}" id="${addon.Addon_Item_Name}" value="${addon.Addon_Item_Price}" data-name="${addon.Addon_Item_Name}" ${isChecked ? 'checked' : ''}><label for="${addon.Addon_Item_Name}">${addon.Addon_Item_Name}</label><span class="price">+ ‚Çπ${addon.Addon_Item_Price}</span></div>`;
                });
                addonHtml += `</div>`;
            }
            custModalContent.innerHTML = `<div class="modal-header"><div class="modal-item-name">${item.Name}</div><span class="close-btn" id="close-cust-modal">&times;</span></div><div class="modal-body">${addonHtml}<textarea class="instructions" id="special-instructions" placeholder="Special instructions...">${existingItem ? existingItem.instructions : ''}</textarea></div><div class="modal-footer"><div class="quantity-control"><button class="quantity-btn" id="decrease-qty">-</button><span class="quantity-display" id="quantity-display">${existingItem ? existingItem.quantity : 1}</span><button class="quantity-btn" id="increase-qty">+</button></div><button class="add-to-cart-btn" id="add-to-cart-btn">${editingCartItemIndex !== null ? 'Update Item' : 'Add Item'}</button></div>`;
            custModalOverlay.classList.add('visible');
            updateModalPrice();
            document.getElementById('decrease-qty').addEventListener('click', () => updateQuantity(-1));
            document.getElementById('increase-qty').addEventListener('click', () => updateQuantity(1));
            document.getElementById('add-to-cart-btn').addEventListener('click', saveItemToCart);
            document.getElementById('close-cust-modal').addEventListener('click', closeCustomizationModal);
            custModalContent.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
                input.addEventListener('change', updateModalPrice);
            });
        }
        
        function updateModalPrice() {
            let addonPrice = Array.from(custModalContent.querySelectorAll('input:checked')).reduce((sum, input) => sum + parseFloat(input.value), 0);
            const quantity = parseInt(document.getElementById('quantity-display').textContent);
            const totalItemPrice = (currentItemForModal.Price + addonPrice) * quantity;
            document.getElementById('add-to-cart-btn').textContent = `${editingCartItemIndex !== null ? 'Update' : 'Add'} Item - ‚Çπ${totalItemPrice.toFixed(2)}`;
        }

        function updateQuantity(change) {
            const qtyDisplay = document.getElementById('quantity-display');
            let currentQty = parseInt(qtyDisplay.textContent) + change;
            if (currentQty < 1) currentQty = 1;
            qtyDisplay.textContent = currentQty;
            updateModalPrice();
        }

        function closeCustomizationModal() {
            custModalOverlay.classList.remove('visible');
            custModalContent.innerHTML = '';
            currentItemForModal = null;
            editingCartItemIndex = null;
        }
        
        function saveItemToCart() {
            const selectedAddons = Array.from(custModalContent.querySelectorAll('input:checked')).map(input => ({ name: input.dataset.name, price: parseFloat(input.value) }));
            const quantity = parseInt(document.getElementById('quantity-display').textContent);
            const instructions = document.getElementById('special-instructions').value;
            const basePrice = currentItemForModal.Price;
            const addonsTotalPrice = selectedAddons.reduce((sum, addon) => sum + addon.price, 0);
            const itemSubtotal = (basePrice + addonsTotalPrice) * quantity;
            const cartItem = { ...currentItemForModal, selectedAddons, quantity, instructions, subtotal: itemSubtotal };
            if (editingCartItemIndex !== null) {
                cart[editingCartItemIndex] = cartItem;
            } else {
                cart.push(cartItem);
            }
            updateCartSummary();
            renderItems(activeCategory);
            closeCustomizationModal();
        }

        function renderCartModal() {
            cartModalBody.innerHTML = '';
            if (cart.length === 0) {
                cartModalBody.innerHTML = '<p style="padding: 20px; text-align: center;">Your cart is empty.</p>';
                cartTotalsSummary.innerHTML = '';
                return;
            }
            cart.forEach((item, index) => {
                let addonsHtml = item.selectedAddons.map(addon => `<li>${addon.name}</li>`).join('');
                if (addonsHtml) addonsHtml = `<ul class="cart-item-addons">${addonsHtml}</ul>`;
                let instructionsHtml = item.instructions ? `<p class="cart-item-instructions">"${item.instructions}"</p>` : '';
                const cartItemDiv = document.createElement('div');
                cartItemDiv.className = 'cart-item';
                cartItemDiv.innerHTML = `<div class="cart-item-name"><div class="attribute-icon ${getAttributeClass(item.Attributes)}"></div>${item.quantity} x ${item.Name}</div>${addonsHtml}${instructionsHtml}<div class="cart-item-footer"><div class="cart-item-actions"><button class="cart-edit-btn" data-cart-index="${index}">Edit</button><button class="cart-remove-btn" data-cart-index="${index}">Remove</button></div><div class="cart-item-price">‚Çπ${item.subtotal.toFixed(2)}</div></div>`;
                cartModalBody.appendChild(cartItemDiv);
            });

            const { subtotal, discount, gst, grandTotal } = calculateTotals();
            cartTotalsSummary.innerHTML = `
                <div class="totals-row"><span>Subtotal</span><span>‚Çπ${subtotal.toFixed(2)}</span></div>
                ${discount > 0 ? `<div class="totals-row" style="color: #25D366;"><span>Discount (${appliedDiscount})</span><span>-‚Çπ${discount.toFixed(2)}</span></div>` : ''}
                <div class="totals-row"><span>GST (5%)</span><span>‚Çπ${gst.toFixed(2)}</span></div>
                <div class="totals-row grand-total"><span>Grand Total</span><span>‚Çπ${grandTotal.toFixed(2)}</span></div>
            `;
            cartModalBody.querySelectorAll('.cart-edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const cartIndex = parseInt(e.target.dataset.cartIndex);
                    cartModalOverlay.classList.remove('visible');
                    openCustomizationModal(cart[cartIndex], cartIndex);
                });
            });
            cartModalBody.querySelectorAll('.cart-remove-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    cart.splice(parseInt(e.target.dataset.cartIndex), 1);
                    updateCartSummary();
                    renderCartModal();
                    renderItems(activeCategory);
                });
            });
        }
        
        function calculateTotals() {
            const subtotal = cart.reduce((sum, item) => sum + item.subtotal, 0);
            let discount = 0;
            
            if (appliedDiscount) {
                const discountInfoArray = config.discountCodes[appliedDiscount];
                if (discountInfoArray && Array.isArray(discountInfoArray)) {
                    // Apply all discounts for this code
                    discountInfoArray.forEach(discountInfo => {
                        const discountPercent = parseFloat(discountInfo.discount.replace('%', '')) / 100;
                        const category = discountInfo.category.toLowerCase().trim();
                        
                        if (category === 'all') {
                            discount += subtotal * discountPercent;
                        } else {
                            const categoryTotal = cart
                                .filter(item => {
                                    const itemCategory = (item.Category || '').toLowerCase().trim();
                                    return itemCategory === category;
                                })
                                .reduce((sum, item) => sum + item.subtotal, 0);
                            
                            discount += categoryTotal * discountPercent;
                        }
                    });
                }
            }
            
            const afterDiscount = subtotal - discount;
            const gst = afterDiscount * GST_RATE;
            const grandTotal = afterDiscount + gst;
            
            return { subtotal, discount, gst, grandTotal };
        }

        function updateCartSummary() {
            if (cart.length === 0) {
                cartSummaryBar.classList.remove('visible');
                return;
            }
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const { grandTotal } = calculateTotals();
            
            cartItemCountSpan.textContent = `${totalItems} Item${totalItems > 1 ? 's' : ''}`;
            cartTotalPriceSpan.textContent = grandTotal.toFixed(2);
            cartSummaryBar.classList.add('visible');
        }

        function generateWhatsAppMessage() {
            if (cart.length === 0) {
                alert("Your cart is empty!");
                return null;
            }
            let message = "";
            if (tableNumber) {
                message += `*New Order from Table: ${tableNumber}*\n\n`;
            } else {
                message += "*New Order Request*\n\n";
            }
            cart.forEach((item) => {
                message += `*${item.quantity}x ${item.Name}* - ‚Çπ${item.subtotal.toFixed(2)}\n`;
                if (item.selectedAddons.length > 0) {
                    item.selectedAddons.forEach(addon => { message += `  - _${addon.name}_\n`; });
                }
                if (item.instructions.trim()) {
                    message += `  > _Item Instructions: ${item.instructions.trim()}_\n`;
                }
            });

            const { subtotal, discount, gst, grandTotal } = calculateTotals();
            message += `\n-----------------------------------\n`;
            message += `*Subtotal:* ‚Çπ${subtotal.toFixed(2)}\n`;
            if (discount > 0) {
                message += `*Discount (${appliedDiscount}):* -‚Çπ${discount.toFixed(2)}\n`;
            }
            message += `*GST (5%):* ‚Çπ${gst.toFixed(2)}\n`;
            message += `*Grand Total: ‚Çπ${grandTotal.toFixed(2)}*\n`;
            message += `-----------------------------------\n`;

            const generalInstructions = document.getElementById('general-instructions').value.trim();
            if (generalInstructions) {
                message += `\n*General Instructions:*\n_${generalInstructions}_`;
            }
            return encodeURIComponent(message);
        }

        function applyDiscountCode() {
            const code = document.getElementById('discount-code-input').value.trim();
            const messageEl = document.getElementById('discount-message');
            
            if (!code) {
                messageEl.style.color = '#d9534f';
                messageEl.textContent = 'Please enter a discount code';
                return;
            }
            
            let discountCode = code;
            let discountInfoArray = config.discountCodes ? config.discountCodes[code] : null;
            
            if (!discountInfoArray) {
                discountCode = code.toUpperCase();
                discountInfoArray = config.discountCodes ? config.discountCodes[discountCode] : null;
            }
            
            if (!discountInfoArray || !Array.isArray(discountInfoArray)) {
                messageEl.style.color = '#d9534f';
                messageEl.textContent = 'Invalid discount code';
                appliedDiscount = null;
                renderCartModal();
                return;
            }
            
            // Check if any discount rules match items in cart
            let hasMatchingItems = false;
            let applicableCategories = [];
            
            discountInfoArray.forEach(discountInfo => {
                const category = discountInfo.category.toLowerCase().trim();
                
                if (category === 'all') {
                    if (cart.length > 0) {
                        hasMatchingItems = true;
                        applicableCategories.push('all items');
                    }
                } else {
                    const hasCategory = cart.some(item => {
                        const itemCategory = (item.Category || '').toLowerCase().trim();
                        return itemCategory === category;
                    });
                    if (hasCategory) {
                        hasMatchingItems = true;
                        applicableCategories.push(category);
                    }
                }
            });
            
            if (!hasMatchingItems) {
                const allCategories = discountInfoArray.map(d => d.category).join(', ');
                messageEl.style.color = '#d9534f';
                messageEl.textContent = `No applicable items in cart for: ${allCategories}`;
                appliedDiscount = null;
                renderCartModal();
                return;
            }
            
            appliedDiscount = discountCode;
            messageEl.style.color = '#25D366';
            
            // Show all applied discounts
            const discountSummary = discountInfoArray.map(d => `${d.discount} on ${d.category}`).join(', ');
            messageEl.textContent = `‚úì Discounts applied: ${discountSummary}`;
            renderCartModal();
        }

        custModalOverlay.addEventListener('click', (e) => { if (e.target === custModalOverlay) closeCustomizationModal(); });
        cartModalOverlay.addEventListener('click', (e) => { if (e.target === cartModalOverlay) cartModalOverlay.classList.remove('visible'); });
        closeCartModalBtn.addEventListener('click', () => cartModalOverlay.classList.remove('visible'));
        
        viewOrderBtn.addEventListener('click', () => {
            renderCartModal();
            cartModalOverlay.classList.add('visible');
        });

        sendWhatsappBtn.addEventListener('click', async () => {
            // Block if outlet is closed
            if (!outletOpen) {
                const statusDiv = document.getElementById('final-check-status');
                statusDiv.style.display = 'block';
                statusDiv.style.color = '#d9534f';
                statusDiv.textContent = 'Outlet is currently closed. Cannot place orders.';
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
                return;
            }
            
            const statusDiv = document.getElementById('final-check-status');
            sendWhatsappBtn.disabled = true;
            sendWhatsappBtn.style.opacity = '0.6';
            statusDiv.style.display = 'block';
            statusDiv.textContent = 'Verifying outlet status...';
            
            try {
                console.log('Re-checking outlet status before placing order...');
                const freshConfig = await fetchConfig();
                
                const tempConfig = config;
                config = freshConfig;
                const statusCheck = checkOutletStatus();
                const locationCheck = await checkUserLocation();
                
                if (!statusCheck.open) {
                    config = tempConfig;
                    statusDiv.style.color = '#d9534f';
                    statusDiv.textContent = statusCheck.reason;
                    sendWhatsappBtn.disabled = false;
                    sendWhatsappBtn.style.opacity = '1';
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 4000);
                    return;
                }
                
                if (!locationCheck.allowed) {
                    config = tempConfig;
                    statusDiv.style.color = '#d9534f';
                    statusDiv.textContent = locationCheck.reason;
                    sendWhatsappBtn.disabled = false;
                    sendWhatsappBtn.style.opacity = '1';
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 4000);
                    return;
                }
                
                // Validate discount code with fresh data
                if (appliedDiscount) {
                    statusDiv.textContent = 'Verifying discount code...';
                    const freshDiscountInfoArray = freshConfig.discountCodes ? freshConfig.discountCodes[appliedDiscount] : null;
                    
                    if (!freshDiscountInfoArray || !Array.isArray(freshDiscountInfoArray)) {
                        config = tempConfig;
                        statusDiv.style.color = '#d9534f';
                        statusDiv.textContent = 'Discount code is no longer valid. Please remove and try again.';
                        sendWhatsappBtn.disabled = false;
                        sendWhatsappBtn.style.opacity = '1';
                        setTimeout(() => {
                            statusDiv.style.display = 'none';
                        }, 4000);
                        return;
                    }
                    
                    // Update config with fresh discount data
                    config = freshConfig;
                    
                    console.log('Fresh discount validation passed');
                } else {
                    config = freshConfig;
                }
                
                // All checks passed - show confirmation modal
                statusDiv.style.color = '#25D366';
                statusDiv.textContent = 'Verified! Preparing confirmation...';
                
                setTimeout(() => {
                    sendWhatsappBtn.disabled = false;
                    sendWhatsappBtn.style.opacity = '1';
                    statusDiv.style.display = 'none';
                    showConfirmationModal();
                    config = tempConfig;
                }, 500);
                
            } catch (error) {
                console.error('Error during final verification:', error);
                statusDiv.style.color = '#d9534f';
                statusDiv.textContent = 'Verification failed. Please try again.';
                sendWhatsappBtn.disabled = false;
                sendWhatsappBtn.style.opacity = '1';
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        });

        function showConfirmationModal() {
            const { subtotal, discount, gst, grandTotal } = calculateTotals();
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            
            let confirmHtml = `
                <div style="margin-bottom: 20px;">
                    <h4 style="font-size: 1.1em; color: #333; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 8px;">Order Items</h4>
            `;
            
            cart.forEach((item, index) => {
                confirmHtml += `
                    <div style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #eee;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 700; color: #333; font-size: 0.95em; margin-bottom: 4px;">
                                    ${item.quantity}x ${item.Name}
                                </div>
                `;
                
                if (item.selectedAddons && item.selectedAddons.length > 0) {
                    confirmHtml += `<div style="font-size: 0.85em; color: #666; margin-left: 10px; margin-top: 5px;">`;
                    item.selectedAddons.forEach(addon => {
                        confirmHtml += `<div style="margin-bottom: 2px;">+ ${addon.name}</div>`;
                    });
                    confirmHtml += `</div>`;
                }
                
                if (item.instructions && item.instructions.trim()) {
                    confirmHtml += `<div style="font-size: 0.85em; color: #d9534f; font-style: italic; margin-left: 10px; margin-top: 5px;">"${item.instructions.trim()}"</div>`;
                }
                
                confirmHtml += `
                            </div>
                            <div style="font-weight: 700; color: #25D366; white-space: nowrap; margin-left: 10px;">
                                ‚Çπ${item.subtotal.toFixed(2)}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            const generalInstructions = document.getElementById('general-instructions').value.trim();
            if (generalInstructions) {
                confirmHtml += `
                    <div style="margin-top: 15px; padding: 12px; background: #fff8e1; border-radius: 8px; border-left: 4px solid #ffd93d;">
                        <div style="font-weight: 600; color: #333; font-size: 0.9em; margin-bottom: 5px;">General Instructions:</div>
                        <div style="font-size: 0.85em; color: #666; font-style: italic;">"${generalInstructions}"</div>
                    </div>
                `;
            }
            
            confirmHtml += `</div>`;
            
            confirmHtml += `
                <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border: 1px solid #d1e7ff;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95em;">
                        <span style="color: #666;">Subtotal:</span>
                        <span style="font-weight: 600;">‚Çπ${subtotal.toFixed(2)}</span>
                    </div>
            `;
            
            if (discount > 0) {
                confirmHtml += `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #25D366; font-size: 0.95em;">
                        <span>Discount (${appliedDiscount}):</span>
                        <span style="font-weight: 600;">-‚Çπ${discount.toFixed(2)}</span>
                    </div>
                `;
            }
            
            confirmHtml += `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95em;">
                        <span style="color: #666;">GST (5%):</span>
                        <span style="font-weight: 600;">‚Çπ${gst.toFixed(2)}</span>
                    </div>
                    <div style="border-top: 2px solid #25D366; padding-top: 10px; margin-top: 10px; display: flex; justify-content: space-between; font-size: 1.2em;">
                        <span style="font-weight: 700; color: #333;">TOTAL:</span>
                        <span style="font-weight: 700; color: #25D366;">‚Çπ${grandTotal.toFixed(2)}</span>
                    </div>
                </div>
            `;
            
            document.getElementById('confirmation-details').innerHTML = confirmHtml;
            confirmationModalOverlay.classList.add('visible');
        }

        closeConfirmationModalBtn.addEventListener('click', () => {
            confirmationModalOverlay.classList.remove('visible');
        });

        cancelOrderBtn.addEventListener('click', () => {
            confirmationModalOverlay.classList.remove('visible');
        });

        confirmSendBtn.addEventListener('click', () => {
            const message = generateWhatsAppMessage();
            if (message) {
                window.open(`https://api.whatsapp.com/send?phone=7011847629&text=${message}`, '_blank');
            }
            confirmationModalOverlay.classList.remove('visible');
        });

        confirmationModalOverlay.addEventListener('click', (e) => { 
            if (e.target === confirmationModalOverlay) {
                confirmationModalOverlay.classList.remove('visible');
            }
        });

        document.addEventListener('click', (e) => {
            if (e.target && e.target.id === 'apply-discount-btn') {
                applyDiscountCode();
            }
        });

        getTableNumberFromURL();
        
        function hideAddressBar() {
            if (!window.location.hash) {
                if (document.height < window.outerHeight) {
                    document.body.style.height = (window.outerHeight + 50) + 'px';
                }
                setTimeout(() => {
                    window.scrollTo(0, 1);
                }, 50);
            }
        }
        
        window.addEventListener('load', hideAddressBar);
        window.addEventListener('orientationchange', () => {
            setTimeout(hideAddressBar, 200);
        });

        function requestFullScreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen().catch(err => console.log('Fullscreen request failed:', err));
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.mozRequestFullScreen) {
                elem.mozRequestFullScreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
        }

        let hasInteracted = false;
        const triggerFullScreen = () => {
            if (!hasInteracted) {
                hasInteracted = true;
                requestFullScreen();
            }
        };

        document.addEventListener('touchstart', triggerFullScreen, { once: true });
        document.addEventListener('click', triggerFullScreen, { once: true });
        
        document.body.addEventListener('touchmove', (e) => {
            if (e.target === document.body) {
                e.preventDefault();
            }
        }, { passive: false });

        function setViewportHeight() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        setViewportHeight();
        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('orientationchange', setViewportHeight);

        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        loadMenuData().then(() => {
            if (menuItems.length === 0) {
                itemListMain.innerHTML = '<p style="padding: 20px; text-align: center; color: #d9534f;">Error loading menu data. Please refresh the page.</p>';
                return;
            }
            renderCategories();
        });
    });
    </script>
</body>
</html>
